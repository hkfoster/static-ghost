
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Achieving High Availability and the MongoDB PHP driver</title>
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="../favicon.ico">

  <script>
  // Uncomment for testing purposes
  // localStorage.clear();
  
  // Place in <head> above all stylesheet declarations
  function loadFont( fontName, woffUrl, woff2Url ) {
  
    // Test for support
    var browser   = navigator.userAgent,
        noSupport = !window.addEventListener || ( browser.match( /(Android (2|3|4.0|4.1|4.2|4.3))|(Opera (Mini|Mobi))/ ) && !browser.match( /Chrome/ ) );
  
    // Return if not supported
    if ( noSupport ) {
      return;
    }
  
    // Set up localStorage
    var loSto = {};
    try {
      loSto = localStorage || {};
    } catch ( ex ) {}
  
    var localStoragePrefix = 'x-font-' + fontName,
        localStorageUrlKey = localStoragePrefix + 'url',
        localStorageCssKey = localStoragePrefix + 'css',
        storedFontUrl      = loSto[ localStorageUrlKey ],
        storedFontCss      = loSto[ localStorageCssKey ];
  
    // Set up <style> element
    var styleElement = document.createElement( 'style' );
    styleElement.rel = 'stylesheet';
    document.head.appendChild( styleElement );
  
    // localStorage check
    if ( storedFontCss && ( storedFontUrl === woffUrl || storedFontUrl === woff2Url ) ) {
  
      // Apply font style sheet
      styleElement.textContent = storedFontCss;
  
    } else {
  
      // Apply new font (WOFF2 if supported)
      var url = ( woff2Url && supportsWoff2() ) ? woff2Url : woffUrl;
  
      // Fetch font data
      var request = new XMLHttpRequest();
      request.open( 'GET', url );
      request.onload = function() {
        if ( request.status >= 200 && request.status < 400 ) {
  
          // Update localStorage
          loSto[ localStorageUrlKey ] = url;
          loSto[ localStorageCssKey ] = styleElement.textContent = request.responseText;
        }
      };
      request.send();
    }
  
    // Check for WOFF2 support
    function supportsWoff2() {
      if ( !window.FontFace ) {
        return false;
      }
  
      var f = new FontFace( 't', 'url( "data:application/font-woff2," ) format( "woff2" )' );
      f.load();
  
      return f.status === 'loading';
    }
  }
  
  // Instantiate font loader
  loadFont(
    'Proxima Nova',
    '/assets/css/fonts-woff.css?v=682061ecfb',
    '/assets/css/fonts-woff2.css?v=682061ecfb'
  );
  </script>
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=682061ecfb">

  <link rel="canonical" href="http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/">
    
    <meta property="og:site_name" content="Compose Articles">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Achieving High Availability and the MongoDB PHP driver">
    <meta property="og:description" content="This is a guest blog by Jake Olefsky, founder of Toodledo.com. At Toodledo.com, we make tools to help people stay organized and productive. Recently, we released “Outlines”, a tool enabling hierarchical outlines to organize people in their projects....">
    <meta property="og:url" content="http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/">
    <meta property="article:published_time" content="2013-08-15T18:51:41.000Z">
    <meta property="article:modified_time" content="2014-09-01T08:04:10.000Z">
    <meta property="article:tag" content="php">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Achieving High Availability and the MongoDB PHP driver">
    <meta name="twitter:description" content="This is a guest blog by Jake Olefsky, founder of Toodledo.com. At Toodledo.com, we make tools to help people stay organized and productive. Recently, we released “Outlines”, a tool enabling hierarchical outlines to organize people in their projects....">
    <meta name="twitter:url" content="http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Compose Articles",
    "author": {
        "@type": "Person",
        "name": "chris",
        "image": "//www.gravatar.com/avatar/862ad981103f3b95d88e265d980ca2c5?d=404&s=250",
        "url": "http://localhost:2368/author/chris",
        "sameAs": ""
    },
    "headline": "Achieving High Availability and the MongoDB PHP driver",
    "url": "http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/",
    "datePublished": "2013-08-15T18:51:41.000Z",
    "dateModified": "2014-09-01T08:04:10.000Z",
    "keywords": "php",
    "description": "This is a guest blog by Jake Olefsky, founder of Toodledo.com. At Toodledo.com, we make tools to help people stay organized and productive. Recently, we released “Outlines”, a tool enabling hierarchical outlines to organize people in their projects...."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="Compose Articles" href="http://localhost:2368/rss/">
</head>

<body class="post-template tag-php blend-mode">

  <header class="branding" role="banner">
    <a class="logo" href="../"><span class="hidden">Compose</span></a>
    <a class="menu-trigger" href="index.html#?"></a>
    <nav class="main-nav" data-yield="primary_nav" role="navigation">
      <a href="http://127.0.0.1:2368/mongodb/">MongoDB</a>
      <a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a>
      <a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a>
      <a href="http://127.0.0.1:2368/redis/">Redis</a>
      <a href="http://127.0.0.1:2368/postgresql/">PostgreSQL</a>
      <a href="https://app.compose.io">Sign in</a>
      <a class="signup" href="../signup/">Sign up</a>
    </nav>
  </header>
  <main class="content container" role="main">

    


<article class="post tag-php container">
  <header>
    <h1 class="post-title">Achieving High Availability and the MongoDB PHP driver</h1>
    <small class="post-meta"><time class="post-date" datetime="2013-08-15">August 15th, 2013</time></small>
  </header>

<p><em>This is a guest blog by Jake Olefsky, founder of Toodledo.com.</em></p>

<p>At <a href="http://www.toodledo.com/">Toodledo.com</a>, we make tools to help people stay organized and productive. Recently, we released “Outlines”, a tool enabling hierarchical outlines to organize people in their projects. Our main website runs LAMP on dedicated servers. On this new project, we decided to build Outlines entirely in the cloud. We required a high availability service without maintaining our own servers.</p>

<p>MongoDB is, at the core, a high-availability database. To ensure business availability, the application layer must respond properly. The MongoDB drivers bridge the role of database and application availability. Our language of choice is PHP, so our driver is the 10gen PHP MongoDB driver. We will layout some of the challenges we faced, and how we overcame them with early PHP drivers (1.2 and 1.3 branches). Luckily, going forward, the 1.4 release has solved many of these issues.</p>

<p>When starting the project in late 2012, PHP MongoDB drivers were fairly immature. During failure testing, the database layer recovered quickly, but PHP drivers did not. Driver connectivity would lag as much as 30 minutes before recognizing any state changes in the MongoDB replica set. This was not acceptable. We designed a wrapper class for the drivers, which reduced transitions to a few seconds. The key concepts of MongoDB availability and driver integration are:</p>

<h3 id="stepdowntheessenceofhighavailability">Stepdown, the essence of high availability</h3>

<p>When the MongoDB replica set has connectivity issues between nodes and a re-vote is triggered, the result may be that the primary host releases the role and becomes a secondary, while another host becomes primary. This event will prevent actions for between 5-10 seconds during the re-vote and role change. These events happen at the database level. The application layer must handle this gracefully.</p>

<h3 id="reconnectingtomongodb">Reconnecting to MongoDB</h3>

<p>Step downs require a reconnection from the MongoDB drivers. When connection parameters contain a named replica set, and a database failover occurs, the stock drivers take too long to catch and resolve the new state of the replica set. Navigating this caching issue requires immediately attempting a new connection to the database, with the replica set parameter removed.</p>

<p><code>try { new MongoClient("mongodb://user:pass@host1,host2/db, array("replicaSet"=&gt;"myReplicaSet")); } catch(MongoException $e) { new MongoClient("mongodb://user:pass@host,host2/db); }</code></p>

<p>Should this reconnection fail, you can cycle through individual hosts, attempting connections to each until failure. In testing, we always resolved connections using this terse procedure.</p>

<h3 id="achievingwritecertainty">Achieving write certainty</h3>

<p>Good news, we can recover from a failed connection. However, after removing replica set information, we must rediscover the primary and secondary. If connecting to a secondary, reads will work but writes will fail. To handle this gracefully, the application must catch write errors, reconnect to the proper host, and retry the write if possible.</p>

<pre><code>try { $result = $collection-&gt;insert($object, $flags); } catch(MongoException $e) { if($e-&gt;getCode()==10058 || $e-&gt;getCode()==16) { if($this-&gt;reconnect()) $result = $collection-&gt;insert($object, $flags); } }  
</code></pre>

<h3 id="driverversions">Driver versions</h3>

<p>Version 1.2 of the Mongo PHP drivers are terrible. Don’t use them. The main problem encountered was cached connections in a connection pool. The pool reused connections, even if they were invalid. The database was healthy, but the driver’s attempts to read and write were being sent to to invalid connections in the pool. The application grinds to a halt.  This <a href="https://jira.mongodb.org/browse/PHP-426">bug</a> was fixed in version 1.3.0.</p>

<p>Version 1.3 of the drivers are ok. They still have trouble recognizing when a replica set changes configurations. If using the techniques above, you will be ok. However, one annoying bug causes writes to occasionally fail for no reason. This <a href="https://jira.mongodb.org/browse/PHP-700">bug</a> was fixed in version 1.3.7.</p>

<p>Version 1.4 of the drivers are good. The workarounds needed for the 1.3 branch are not necessary. However, it is still a good idea to have a wrapper on the driver to handle write errors, and perform proper application resolution.</p>

<p>If using a PAAS provider, ensure support for the 1.3.7 or 1.4.x driver versions, else switch providers.</p>

<h3 id="ourcode">Our Code</h3>

<p>We have made <a href="https://github.com/Toodledo/mymongo">our MongoDB driver wrapper class available on Github</a> for anyone to use and improve upon.</p>

<h3 id="themoralofthestory">The Moral of the Story</h3>

<p>Upgrade to <a href="http://pecl.php.net/package/mongo/1.4.2">PHP Mongo 1.4.x</a>, and use a wrapper class to  get easier pain free PHP high availability.</p>


<footer class="post-footer big-push">


    <figure class="author">
      <a href="../author/chris/">
        <img src="http://www.gravatar.com/avatar/862ad981103f3b95d88e265d980ca2c5?d=404&amp;s=250" alt="chris">
      </a>
      <figcaption>
        <p>Written on <time class="post-date" datetime="2015-03-13">March 13th, 2015</time> by</p>
        <a href="../author/chris/">chris</a>
          <p>0</p>
      </figcaption>
    </figure>




  <nav class="post-nav">
    <section class="site-nav">
      <a class="article-index" data-tooltip="Article Index" href="http://localhost:2368">
        <span class="hidden">Article Index</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#index"></use>
        </svg>
      </a>
      <a class="subscribe-button" data-tooltip="Suscribe" href="http://localhost:2368/rss/">
        <span class="hidden">Subscribe</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#subscribe"></use>
        </svg>
      </a>
    </section>
    <section class="share-nav">
      <a class="twitter-button" data-tooltip="Share on Twitter" href="https://twitter.com/share?text=Achieving%20High%20Availability%20and%20the%20MongoDB%20PHP%20driver&amp;url=http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#twitter"></use>
        </svg>
      </a>
      <a class="facebook-button" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#facebook"></use>
        </svg>
      </a>
      <a class="google-plus-button" data-tooltip="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:2368/achieving-high-availability-and-the-mongodb-php-driver/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#google-plus"></use>
        </svg>
      </a>
    </section></nav>
  
</footer>

</article>



  </main>

  <footer class="colophon full-push" role="contentinfo">
    <nav>
      <dl>
        <dt>Company</dt>
        <dd><a href="http://127.0.0.1:2368/about-us/">About Us</a><a href="http://blog.compose.io/">Blog</a><a href="http://docs.compose.io/policies">Policies</a><a href="http://127.0.0.1:2368/pricing/">Plans <span class="amp">&amp;</span> Pricing </a><a href="http://127.0.0.1:2368/database-as-a-service/">Database as a Service</a>
        </dd>
      </dl>
      <dl>
        <dt>Support</dt>
        <dd><a href="http://status.compose.io/">System Status</a><a href="http://docs.compose.io/">Support</a><a href="http://docs.compose.io/">Docs</a><a href="http://127.0.0.1:2368/security/">Security</a><a href="https://docs.compose.io/support/new_request.html/?page=www">Contact Us</a>
        </dd>
      </dl>
      <dl>
        <dt>Databases</dt>
        <dd><a href="http://127.0.0.1:2368/mongodb/">MongoDB</a><a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a><a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a><a href="http://127.0.0.1:2368/redis/">Redis</a><a href="http://127.0.0.1:2368/enhanced/">Enhanced</a>
        </dd>
      </dl>
      <dl>
        <dt>Deployments</dt>
        <dd><a href="http://127.0.0.1:2368/aws/">AWS</a><a href="http://127.0.0.1:2368/digitalocean/">DigitalOcean</a><a href="http://127.0.0.1:2368/softlayer/">SoftLayer</a><a href="http://127.0.0.1:2368/gogrid/">GoGrid</a>
        </dd>
      </dl>
    </nav>
    <p>© 2015 Compose. All rights reserved. </p>
  </footer>
  <script src="../public/jquery.js?v=682061ecfb"></script>

  <script type="text/javascript" src="../assets/js/site.js?v=682061ecfb"></script>

</body>
