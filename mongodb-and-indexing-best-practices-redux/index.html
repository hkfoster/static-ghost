
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>MongoDB and Indexing: Best Practices Redux</title>
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="../favicon.ico">

  <script>
  // Uncomment for testing purposes
  // localStorage.clear();
  
  // Place in <head> above all stylesheet declarations
  function loadFont( fontName, woffUrl, woff2Url ) {
  
    // Test for support
    var browser   = navigator.userAgent,
        noSupport = !window.addEventListener || ( browser.match( /(Android (2|3|4.0|4.1|4.2|4.3))|(Opera (Mini|Mobi))/ ) && !browser.match( /Chrome/ ) );
  
    // Return if not supported
    if ( noSupport ) {
      return;
    }
  
    // Set up localStorage
    var loSto = {};
    try {
      loSto = localStorage || {};
    } catch ( ex ) {}
  
    var localStoragePrefix = 'x-font-' + fontName,
        localStorageUrlKey = localStoragePrefix + 'url',
        localStorageCssKey = localStoragePrefix + 'css',
        storedFontUrl      = loSto[ localStorageUrlKey ],
        storedFontCss      = loSto[ localStorageCssKey ];
  
    // Set up <style> element
    var styleElement = document.createElement( 'style' );
    styleElement.rel = 'stylesheet';
    document.head.appendChild( styleElement );
  
    // localStorage check
    if ( storedFontCss && ( storedFontUrl === woffUrl || storedFontUrl === woff2Url ) ) {
  
      // Apply font style sheet
      styleElement.textContent = storedFontCss;
  
    } else {
  
      // Apply new font (WOFF2 if supported)
      var url = ( woff2Url && supportsWoff2() ) ? woff2Url : woffUrl;
  
      // Fetch font data
      var request = new XMLHttpRequest();
      request.open( 'GET', url );
      request.onload = function() {
        if ( request.status >= 200 && request.status < 400 ) {
  
          // Update localStorage
          loSto[ localStorageUrlKey ] = url;
          loSto[ localStorageCssKey ] = styleElement.textContent = request.responseText;
        }
      };
      request.send();
    }
  
    // Check for WOFF2 support
    function supportsWoff2() {
      if ( !window.FontFace ) {
        return false;
      }
  
      var f = new FontFace( 't', 'url( "data:application/font-woff2," ) format( "woff2" )' );
      f.load();
  
      return f.status === 'loading';
    }
  }
  
  // Instantiate font loader
  loadFont(
    'Proxima Nova',
    '/assets/css/fonts-woff.css?v=682061ecfb',
    '/assets/css/fonts-woff2.css?v=682061ecfb'
  );
  </script>
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=682061ecfb">

  <link rel="canonical" href="http://localhost:2368/mongodb-and-indexing-best-practices-redux/">
    
    <meta property="og:site_name" content="Compose Articles">
    <meta property="og:type" content="article">
    <meta property="og:title" content="MongoDB and Indexing: Best Practices Redux">
    <meta property="og:description" content="Back in May last year, we talked about a set of best practices for indexing and MongoDB, focusing on performance. Since then MongoDB 2.6 has arrived and it’s a good time to update that list. One index per...">
    <meta property="og:url" content="http://localhost:2368/mongodb-and-indexing-best-practices-redux/">
    <meta property="og:image" content="http://localhost:2368/content/images/2014/12/Yale_card_catalog_xtn9yt_spjfgn.jpg">
    <meta property="article:published_time" content="2014-06-24T10:01:22.000Z">
    <meta property="article:modified_time" content="2014-09-02T09:27:38.000Z">
    <meta property="article:tag" content="indexing">
    <meta property="article:tag" content="mongodb 2.6">
    <meta property="article:tag" content="performance">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MongoDB and Indexing: Best Practices Redux">
    <meta name="twitter:description" content="Back in May last year, we talked about a set of best practices for indexing and MongoDB, focusing on performance. Since then MongoDB 2.6 has arrived and it’s a good time to update that list. One index per...">
    <meta name="twitter:url" content="http://localhost:2368/mongodb-and-indexing-best-practices-redux/">
    <meta name="twitter:image:src" content="http://localhost:2368/content/images/2014/12/Yale_card_catalog_xtn9yt_spjfgn.jpg">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Compose Articles",
    "author": {
        "@type": "Person",
        "name": "Dj",
        "image": "//www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&s=250",
        "url": "http://localhost:2368/author/dj",
        "sameAs": ""
    },
    "headline": "MongoDB and Indexing: Best Practices Redux",
    "url": "http://localhost:2368/mongodb-and-indexing-best-practices-redux/",
    "datePublished": "2014-06-24T10:01:22.000Z",
    "dateModified": "2014-09-02T09:27:38.000Z",
    "image": "http://localhost:2368/content/images/2014/12/Yale_card_catalog_xtn9yt_spjfgn.jpg",
    "keywords": "indexing, mongodb 2.6, performance",
    "description": "Back in May last year, we talked about a set of best practices for indexing and MongoDB, focusing on performance. Since then MongoDB 2.6 has arrived and it’s a good time to update that list. One index per..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="Compose Articles" href="http://localhost:2368/rss/">
</head>

<body class="post-template tag-indexing tag-mongodb-2-6 tag-performance blend-mode">

  <header class="branding" role="banner">
    <a class="logo" href="../"><span class="hidden">Compose</span></a>
    <a class="menu-trigger" href="index.html#?"></a>
    <nav class="main-nav" data-yield="primary_nav" role="navigation">
      <a href="http://127.0.0.1:2368/mongodb/">MongoDB</a>
      <a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a>
      <a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a>
      <a href="http://127.0.0.1:2368/redis/">Redis</a>
      <a href="http://127.0.0.1:2368/postgresql/">PostgreSQL</a>
      <a href="https://app.compose.io">Sign in</a>
      <a class="signup" href="../signup/">Sign up</a>
    </nav>
  </header>
  <main class="content container" role="main">

    


<article class="post tag-indexing tag-mongodb-2-6 tag-performance container">
  <header class="hero cover-image container" style="background-image: url(../content/images/2014/12/Yale_card_catalog_xtn9yt_spjfgn.jpg)">
    <h1 class="post-title">MongoDB and Indexing: Best Practices Redux</h1>
    <small class="post-meta"><time class="post-date" datetime="2014-06-24">June 24th, 2014</time></small>
  </header>

<p>Back in May last year, we talked about a set of best practices for indexing and MongoDB, focusing on performance. Since then MongoDB 2.6 has arrived and it’s a good time to update that list.</p>

<h2 id="oneindexperquery">One index per query</h2>

<p>MongoDB can only use one index in any one query operation. Although MongoDB 2.6 has introduced index intersection, which allows more than one index to be used (specifically two indexes currently), there are a number of caveats on their use and one index, whether singular or compound, is still easier to manage and optimise around.</p>

<h2 id="onemultivalueoperatorperquery">One “multi-value” operator per query</h2>

<p>There’s a range of selectors we call “multi-value” operators. They can return records that match a variety of different values. They include <code>$gt</code>, <code>$gte</code>, <code>$lt</code> and <code>$lte</code>, <code>$in</code> and <code>$nin</code>, <code>$ne</code>, <code>$not</code> and <code>$near</code>. If you need to use one, use one and no more. This is because the “multi-value” operators can return an unpredictable number of values and are more likely to be scanned to be evaluated – the more you have to scan, the slower the query.</p>

<h2 id="multivaluefieldslastinanindex">“Multi-value” fields last in an index</h2>

<p>If you’re indexing a couple of fields, and one of the fields you expect to be queried using one of those “multi-value” operators we’ve previously mentioned, then it is best to place them at the end of the index. Ideally, the index should be ordered so that the fields you query for exact values come first and the “multi-value” operators come last in the index. A wrinkle in that rule of thumb are fields that are sorted against – they should come between the exact and “multi-value” fields to minimise the amount of in-memory sorting needed.</p>

<h2 id="movelogicintotheschema">Move logic into the schema</h2>

<p>Some things work better with preparation. Consider a situation where you want to find out what time-stamped documents match a particular day. You have a time field for when the document was created and you reach for the <code>find</code> method and write…</p>

<pre><code>db.coll.find(time: { $gte: ISODate('2014-06-23'), $lt: ISODate('2014-06-24') } )  
</code></pre>

<p>…a date greater or equal to midnight of the day we are interested in and less than midnight the day after. There’s going to be a lot of scanning to get the results for that query and it’s all avoidable.</p>

<p>We’re interested in days, so we could create a <code>day_bucket</code> field in the schema and populate that with just the day…</p>

<pre><code>db.coll.insert({ time: ISODate('2014-06-23T14:57:13.556Z'),day_bucket:ISODate("2014-06-23"});  
</code></pre>

<p>Any document for this date will have the same <code>day_bucket</code> value, so now we can query for a simple equivalence:</p>

<pre><code>db.coll.find(time:ISODate('2014-06-23') )  
</code></pre>

<p>And a simple equivalence is a lot easier to scan for and index. By using techniques like this, you can optimise a range of database-stressing operations into one compact query.</p>

<h2 id="justenoughindexes">Just enough indexes</h2>

<p>The temptation to create many indexes for all possible queries can be high, but don’t succumb to that temptation. Every index created has a cost at insert time of longer write locking or more work for background threads. And the chances are that far from all the indexes are actively used, especially when you recall what we said about one index per query. So if you have a collection inserting slowly or locking the database for too long, get a list of what indexes there are with <code>db.coll.getIndexes()</code> and make sure you need them. And if you do need them, make sure the queries that use them are making best use of the indexes.</p>

<h2 id="indexesinram">Indexes in RAM</h2>

<p>It may seem obvious, but for best performance of indexing, the indexes should be kept in RAM. It goes with the previous best practice: those unused indexes will all jostle for a seat in the RAM and marching them to and from disk is not going to be an efficient use of your databases time. Make sure your indexes fit in RAM and don’t have to fight for their right to memory.</p>


<footer class="post-footer big-push">


    <figure class="author">
      <a href="../author/dj/">
        <img src="http://www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&amp;s=250" alt="Dj">
      </a>
      <figcaption>
        <p>Written on <time class="post-date" datetime="2015-03-13">March 13th, 2015</time> by</p>
        <a href="../author/dj/">Dj</a>
          <p>Content Curator at Compose, Dj has been both a developer and writer since Apples came in ][ flavors and Commodores had Pets.</p>
      </figcaption>
    </figure>




  <nav class="post-nav">
    <section class="site-nav">
      <a class="article-index" data-tooltip="Article Index" href="http://localhost:2368">
        <span class="hidden">Article Index</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#index"></use>
        </svg>
      </a>
      <a class="subscribe-button" data-tooltip="Suscribe" href="http://localhost:2368/rss/">
        <span class="hidden">Subscribe</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#subscribe"></use>
        </svg>
      </a>
    </section>
    <section class="share-nav">
      <a class="twitter-button" data-tooltip="Share on Twitter" href="https://twitter.com/share?text=MongoDB%20and%20Indexing%3A%20Best%20Practices%20Redux&amp;url=http://localhost:2368/mongodb-and-indexing-best-practices-redux/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#twitter"></use>
        </svg>
      </a>
      <a class="facebook-button" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/mongodb-and-indexing-best-practices-redux/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#facebook"></use>
        </svg>
      </a>
      <a class="google-plus-button" data-tooltip="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:2368/mongodb-and-indexing-best-practices-redux/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#google-plus"></use>
        </svg>
      </a>
    </section></nav>
  
</footer>

</article>



  </main>

  <footer class="colophon full-push" role="contentinfo">
    <nav>
      <dl>
        <dt>Company</dt>
        <dd><a href="http://127.0.0.1:2368/about-us/">About Us</a><a href="http://blog.compose.io/">Blog</a><a href="http://docs.compose.io/policies">Policies</a><a href="http://127.0.0.1:2368/pricing/">Plans <span class="amp">&amp;</span> Pricing </a><a href="http://127.0.0.1:2368/database-as-a-service/">Database as a Service</a>
        </dd>
      </dl>
      <dl>
        <dt>Support</dt>
        <dd><a href="http://status.compose.io/">System Status</a><a href="http://docs.compose.io/">Support</a><a href="http://docs.compose.io/">Docs</a><a href="http://127.0.0.1:2368/security/">Security</a><a href="https://docs.compose.io/support/new_request.html/?page=www">Contact Us</a>
        </dd>
      </dl>
      <dl>
        <dt>Databases</dt>
        <dd><a href="http://127.0.0.1:2368/mongodb/">MongoDB</a><a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a><a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a><a href="http://127.0.0.1:2368/redis/">Redis</a><a href="http://127.0.0.1:2368/enhanced/">Enhanced</a>
        </dd>
      </dl>
      <dl>
        <dt>Deployments</dt>
        <dd><a href="http://127.0.0.1:2368/aws/">AWS</a><a href="http://127.0.0.1:2368/digitalocean/">DigitalOcean</a><a href="http://127.0.0.1:2368/softlayer/">SoftLayer</a><a href="http://127.0.0.1:2368/gogrid/">GoGrid</a>
        </dd>
      </dl>
    </nav>
    <p>© 2015 Compose. All rights reserved. </p>
  </footer>
  <script src="../public/jquery.js?v=682061ecfb"></script>

  <script type="text/javascript" src="../assets/js/site.js?v=682061ecfb"></script>

</body>
