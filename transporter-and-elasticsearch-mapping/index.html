
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Transporter and Elasticsearch Mapping</title>
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="../favicon.ico">

  <script>
  // Uncomment for testing purposes
  // localStorage.clear();
  
  // Place in <head> above all stylesheet declarations
  function loadFont( fontName, woffUrl, woff2Url ) {
  
    // Test for support
    var browser   = navigator.userAgent,
        noSupport = !window.addEventListener || ( browser.match( /(Android (2|3|4.0|4.1|4.2|4.3))|(Opera (Mini|Mobi))/ ) && !browser.match( /Chrome/ ) );
  
    // Return if not supported
    if ( noSupport ) {
      return;
    }
  
    // Set up localStorage
    var loSto = {};
    try {
      loSto = localStorage || {};
    } catch ( ex ) {}
  
    var localStoragePrefix = 'x-font-' + fontName,
        localStorageUrlKey = localStoragePrefix + 'url',
        localStorageCssKey = localStoragePrefix + 'css',
        storedFontUrl      = loSto[ localStorageUrlKey ],
        storedFontCss      = loSto[ localStorageCssKey ];
  
    // Set up <style> element
    var styleElement = document.createElement( 'style' );
    styleElement.rel = 'stylesheet';
    document.head.appendChild( styleElement );
  
    // localStorage check
    if ( storedFontCss && ( storedFontUrl === woffUrl || storedFontUrl === woff2Url ) ) {
  
      // Apply font style sheet
      styleElement.textContent = storedFontCss;
  
    } else {
  
      // Apply new font (WOFF2 if supported)
      var url = ( woff2Url && supportsWoff2() ) ? woff2Url : woffUrl;
  
      // Fetch font data
      var request = new XMLHttpRequest();
      request.open( 'GET', url );
      request.onload = function() {
        if ( request.status >= 200 && request.status < 400 ) {
  
          // Update localStorage
          loSto[ localStorageUrlKey ] = url;
          loSto[ localStorageCssKey ] = styleElement.textContent = request.responseText;
        }
      };
      request.send();
    }
  
    // Check for WOFF2 support
    function supportsWoff2() {
      if ( !window.FontFace ) {
        return false;
      }
  
      var f = new FontFace( 't', 'url( "data:application/font-woff2," ) format( "woff2" )' );
      f.load();
  
      return f.status === 'loading';
    }
  }
  
  // Instantiate font loader
  loadFont(
    'Proxima Nova',
    '/assets/css/fonts-woff.css?v=682061ecfb',
    '/assets/css/fonts-woff2.css?v=682061ecfb'
  );
  </script>
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=682061ecfb">

  <link rel="canonical" href="http://localhost:2368/transporter-and-elasticsearch-mapping/">
    
    <meta property="og:site_name" content="Compose Articles">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Transporter and Elasticsearch Mapping">
    <meta property="og:description" content="Now that Compose has Elasticsearch and Transporter, we’ve been looking at the process of moving data around and the particular obstacles one can meet in the process. One of the smart things that Elasticsearch does when data is being...">
    <meta property="og:url" content="http://localhost:2368/transporter-and-elasticsearch-mapping/">
    <meta property="og:image" content="http://localhost:2368/content/images/2014/12/lightblueburst_qfrnsr_fmathp.jpg">
    <meta property="article:published_time" content="2014-09-30T10:00:56.000Z">
    <meta property="article:modified_time" content="2014-12-17T09:38:00.000Z">
    <meta property="article:tag" content="javascript">
    <meta property="article:tag" content="mapping">
    <meta property="article:tag" content="transporter">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Transporter and Elasticsearch Mapping">
    <meta name="twitter:description" content="Now that Compose has Elasticsearch and Transporter, we’ve been looking at the process of moving data around and the particular obstacles one can meet in the process. One of the smart things that Elasticsearch does when data is being...">
    <meta name="twitter:url" content="http://localhost:2368/transporter-and-elasticsearch-mapping/">
    <meta name="twitter:image:src" content="http://localhost:2368/content/images/2014/12/lightblueburst_qfrnsr_fmathp.jpg">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Compose Articles",
    "author": {
        "@type": "Person",
        "name": "Dj",
        "image": "//www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&s=250",
        "url": "http://localhost:2368/author/dj",
        "sameAs": ""
    },
    "headline": "Transporter and Elasticsearch Mapping",
    "url": "http://localhost:2368/transporter-and-elasticsearch-mapping/",
    "datePublished": "2014-09-30T10:00:56.000Z",
    "dateModified": "2014-12-17T09:38:00.000Z",
    "image": "http://localhost:2368/content/images/2014/12/lightblueburst_qfrnsr_fmathp.jpg",
    "keywords": "javascript, mapping, transporter",
    "description": "Now that Compose has Elasticsearch and Transporter, we’ve been looking at the process of moving data around and the particular obstacles one can meet in the process. One of the smart things that Elasticsearch does when data is being..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="Compose Articles" href="http://localhost:2368/rss/">
</head>

<body class="post-template tag-javascript tag-mapping tag-transporter blend-mode">

  <header class="branding" role="banner">
    <a class="logo" href="../"><span class="hidden">Compose</span></a>
    <a class="menu-trigger" href="index.html#?"></a>
    <nav class="main-nav" data-yield="primary_nav" role="navigation">
      <a href="http://127.0.0.1:2368/mongodb/">MongoDB</a>
      <a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a>
      <a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a>
      <a href="http://127.0.0.1:2368/redis/">Redis</a>
      <a href="http://127.0.0.1:2368/postgresql/">PostgreSQL</a>
      <a href="https://app.compose.io">Sign in</a>
      <a class="signup" href="../signup/">Sign up</a>
    </nav>
  </header>
  <main class="content container" role="main">

    


<article class="post tag-javascript tag-mapping tag-transporter container">
  <header class="hero cover-image container" style="background-image: url(../content/images/2014/12/lightblueburst_qfrnsr_fmathp.jpg)">
    <h1 class="post-title">Transporter and Elasticsearch Mapping</h1>
    <small class="post-meta"><time class="post-date" datetime="2014-09-30">September 30th, 2014</time></small>
  </header>

<p>Now that Compose has Elasticsearch and Transporter, we’ve been looking at the process of moving data around and the particular obstacles one can meet in the process. One of the smart things that Elasticsearch does when data is being put into one of its indexes is to create a dynamic type mapping of the data as its inserted. So where it sees a field with a date, it adds to the dynamic type mapping that that field is a date and carries on. <img src="../content/images/2014/12/transporter-rounded_rcfgnn_wjjgip.png" alt="Transporter logo" title=""> When you come to query the data in the index, Elasticsearch can use that type and immediately apply search semantics suitable for dates.</p>

<p>This is very useful but there’s a problem that can catch users out when using this dynamic type mapping and that’s numbers. Say the first record you have being imported has a field “myval” and it is set to “100”. Elasticsearch will look at that and quite reasonably decide that it is an integer and set the mapping type to integer. But say in the second record, “myval” is now “100.123”. Elasticsearch will look at the type defined and try and parse it as an integer, which in turn will cause an error in Elasticsearch.</p>

<p>Ah, you say, we’ll just make sure that the numbers are all consistently formatted as floating point or integer as appropriate in the database. Which would be a good idea, but when you are dealing with MongoDB – you are dealing with JSON and JavaScript… and there’s something you need to know about how they handle numbers.</p>

<p>JavaScript, and by extension JSON don’t really have types like Integer, Double or Float for numbers – they just have <code>Number</code>, an all purpose holder for numeric values which doesn’t distinguish between floating point and integer numbers. Instead <code>Number</code> actually stores the value as a floating point number. The format of the number is decided when the value is extracted from the <code>Number</code>. It’s meant to be flexible in a dynamic scripting language where type is implied.</p>

<p>But it also means that where you have an integer in a floating point variable it will be rendered as an integer and when that number is read by a Java application like Elasticsearch, it’ll see an integer and set the field type to integer in the scenario we outlined above. If you are using the Compose Transporter to push data into Elasticsearch, you are most probably not going to want to try and create mappings to pre-empt this behavior, especially if your data is in records with very variable structure.</p>

<p>So what to do? Well, there is a little trick you can do with the Transformer part of the Transporter and that trick is to make all integers into strings. Let’s show you the code, then we’ll explain. Here’s the <code>norm</code> function…</p>

<pre><code>&lt;code class="language-javascript"&gt;function norm(obj) {  
  Object.keys(obj).forEach(function(k) {
      if(typeof obj[k] === "number") {
        if(Number.isInteger(obj[k])) {
          obj[k]=obj[k]+".0";
        }  
      }
        else if(typeof obj[k] === "object") {
        norm(obj[k]);
        }
     });
}

module.exports = function(doc) {  
  var o=_.pick(doc, [ "_id", "val"]);
  norm(o);
  return o;
}
</code></pre>

<p>When the <code>norm</code> function is given any JavaScript object, it recursively steps through it. Where it finds fields are of type <code>Number</code> which also have a value that is an integer, the function swaps the number for a string made up of the integer’s value with “.0″ appended.</p>

<p>Now, with the number in the form of a string, Elasticsearch will see a string and upon parsing it see a floating point value which it can will type as a double. Now later records with floating point values won’t trigger an error.</p>

<h2 id="isinteger">isInteger?</h2>

<p>There’s one small JavaScript issue though; although <code>Number.isInteger</code> is supported in many modern browsers, as part of ECMAScript 6 – the upcoming new standard version – it isn’t supported by the Transporter’s JavaScript engine, it supports the current version as is.</p>

<p>The code above will run in the Transporter’s Transformer creation page because in that page, it uses the browsers JavaScript implementation to test the code, but it will throw an error when the Transporter job is submitted.</p>

<p>That’s not as big a problem as it may sound though. The same issue exists for older browsers and the solution is called a polyfill. That’s some code which “fills” the functionality gap where the function isn’t present. Here’s a polyfill for <code>Number.isInteger</code>:</p>

<pre><code>&lt;code class="language-javascript"&gt;if (!Number.isInteger) {  
  Number.isInteger = function isInteger (nVal) {
    return typeof nVal === "number" &amp;&amp; isFinite(nVal) &amp;&amp; nVal &gt; -9007199254740992 &amp;&amp; nVal &lt; 9007199254740992 &amp;&amp; Math.floor(nVal) === nVal;
  };
}
</code></pre>

<p>Pop that snippet before the preceding code and whenever <code>Number.isInteger</code> is not defined, it’ll add a definition and you can progress.</p>

<h2 id="moremapping">More mapping</h2>

<p>The function we’ve offered here is designed to address one particular mapping problem but that doesn’t mean it’s all you can do. You could modify the function to correct any mapping deficiency you may encounter, reformat if fields or perform more complex modifications (though we suggest that the built in Underscore library may be a good place to start if you don’t want to recurse through the entire document object). This should, though, show the power of having JavaScript in the Transporter… and this is only the beginning.</p>


<footer class="post-footer big-push">


    <figure class="author">
      <a href="../author/dj/">
        <img src="http://www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&amp;s=250" alt="Dj">
      </a>
      <figcaption>
        <p>Written on <time class="post-date" datetime="2015-03-13">March 13th, 2015</time> by</p>
        <a href="../author/dj/">Dj</a>
          <p>Content Curator at Compose, Dj has been both a developer and writer since Apples came in ][ flavors and Commodores had Pets.</p>
      </figcaption>
    </figure>




  <nav class="post-nav">
    <section class="site-nav">
      <a class="article-index" data-tooltip="Article Index" href="http://localhost:2368">
        <span class="hidden">Article Index</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#index"></use>
        </svg>
      </a>
      <a class="subscribe-button" data-tooltip="Suscribe" href="http://localhost:2368/rss/">
        <span class="hidden">Subscribe</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#subscribe"></use>
        </svg>
      </a>
    </section>
    <section class="share-nav">
      <a class="twitter-button" data-tooltip="Share on Twitter" href="https://twitter.com/share?text=Transporter%20and%20Elasticsearch%20Mapping&amp;url=http://localhost:2368/transporter-and-elasticsearch-mapping/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#twitter"></use>
        </svg>
      </a>
      <a class="facebook-button" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/transporter-and-elasticsearch-mapping/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#facebook"></use>
        </svg>
      </a>
      <a class="google-plus-button" data-tooltip="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:2368/transporter-and-elasticsearch-mapping/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#google-plus"></use>
        </svg>
      </a>
    </section></nav>
  
</footer>

</article>



  </main>

  <footer class="colophon full-push" role="contentinfo">
    <nav>
      <dl>
        <dt>Company</dt>
        <dd><a href="http://127.0.0.1:2368/about-us/">About Us</a><a href="http://blog.compose.io/">Blog</a><a href="http://docs.compose.io/policies">Policies</a><a href="http://127.0.0.1:2368/pricing/">Plans <span class="amp">&amp;</span> Pricing </a><a href="http://127.0.0.1:2368/database-as-a-service/">Database as a Service</a>
        </dd>
      </dl>
      <dl>
        <dt>Support</dt>
        <dd><a href="http://status.compose.io/">System Status</a><a href="http://docs.compose.io/">Support</a><a href="http://docs.compose.io/">Docs</a><a href="http://127.0.0.1:2368/security/">Security</a><a href="https://docs.compose.io/support/new_request.html/?page=www">Contact Us</a>
        </dd>
      </dl>
      <dl>
        <dt>Databases</dt>
        <dd><a href="http://127.0.0.1:2368/mongodb/">MongoDB</a><a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a><a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a><a href="http://127.0.0.1:2368/redis/">Redis</a><a href="http://127.0.0.1:2368/enhanced/">Enhanced</a>
        </dd>
      </dl>
      <dl>
        <dt>Deployments</dt>
        <dd><a href="http://127.0.0.1:2368/aws/">AWS</a><a href="http://127.0.0.1:2368/digitalocean/">DigitalOcean</a><a href="http://127.0.0.1:2368/softlayer/">SoftLayer</a><a href="http://127.0.0.1:2368/gogrid/">GoGrid</a>
        </dd>
      </dl>
    </nav>
    <p>© 2015 Compose. All rights reserved. </p>
  </footer>
  <script src="../public/jquery.js?v=682061ecfb"></script>

  <script type="text/javascript" src="../assets/js/site.js?v=682061ecfb"></script>

</body>
