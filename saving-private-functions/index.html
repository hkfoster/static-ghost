
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Saving Private Functions</title>
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="../favicon.ico">

  <script>
  // Uncomment for testing purposes
  // localStorage.clear();
  
  // Place in <head> above all stylesheet declarations
  function loadFont( fontName, woffUrl, woff2Url ) {
  
    // Test for support
    var browser   = navigator.userAgent,
        noSupport = !window.addEventListener || ( browser.match( /(Android (2|3|4.0|4.1|4.2|4.3))|(Opera (Mini|Mobi))/ ) && !browser.match( /Chrome/ ) );
  
    // Return if not supported
    if ( noSupport ) {
      return;
    }
  
    // Set up localStorage
    var loSto = {};
    try {
      loSto = localStorage || {};
    } catch ( ex ) {}
  
    var localStoragePrefix = 'x-font-' + fontName,
        localStorageUrlKey = localStoragePrefix + 'url',
        localStorageCssKey = localStoragePrefix + 'css',
        storedFontUrl      = loSto[ localStorageUrlKey ],
        storedFontCss      = loSto[ localStorageCssKey ];
  
    // Set up <style> element
    var styleElement = document.createElement( 'style' );
    styleElement.rel = 'stylesheet';
    document.head.appendChild( styleElement );
  
    // localStorage check
    if ( storedFontCss && ( storedFontUrl === woffUrl || storedFontUrl === woff2Url ) ) {
  
      // Apply font style sheet
      styleElement.textContent = storedFontCss;
  
    } else {
  
      // Apply new font (WOFF2 if supported)
      var url = ( woff2Url && supportsWoff2() ) ? woff2Url : woffUrl;
  
      // Fetch font data
      var request = new XMLHttpRequest();
      request.open( 'GET', url );
      request.onload = function() {
        if ( request.status >= 200 && request.status < 400 ) {
  
          // Update localStorage
          loSto[ localStorageUrlKey ] = url;
          loSto[ localStorageCssKey ] = styleElement.textContent = request.responseText;
        }
      };
      request.send();
    }
  
    // Check for WOFF2 support
    function supportsWoff2() {
      if ( !window.FontFace ) {
        return false;
      }
  
      var f = new FontFace( 't', 'url( "data:application/font-woff2," ) format( "woff2" )' );
      f.load();
  
      return f.status === 'loading';
    }
  }
  
  // Instantiate font loader
  loadFont(
    'Proxima Nova',
    '/assets/css/fonts-woff.css?v=682061ecfb',
    '/assets/css/fonts-woff2.css?v=682061ecfb'
  );
  </script>
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=682061ecfb">

  <link rel="canonical" href="http://localhost:2368/saving-private-functions/">
    
    <meta property="og:site_name" content="Compose Articles">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Saving Private Functions">
    <meta property="og:description" content="Extending the Mongo Shell In the last blog post, we had a look at how you could make the Mongo Shell work more efficiently for you by using a combination of JavaScript functions and the Shell’s edit helper. But...">
    <meta property="og:url" content="http://localhost:2368/saving-private-functions/">
    <meta property="article:published_time" content="2014-01-23T20:39:52.000Z">
    <meta property="article:modified_time" content="2014-09-01T07:40:34.000Z">
    <meta property="article:tag" content="javascript">
    <meta property="article:tag" content="shell">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Saving Private Functions">
    <meta name="twitter:description" content="Extending the Mongo Shell In the last blog post, we had a look at how you could make the Mongo Shell work more efficiently for you by using a combination of JavaScript functions and the Shell’s edit helper. But...">
    <meta name="twitter:url" content="http://localhost:2368/saving-private-functions/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Compose Articles",
    "author": {
        "@type": "Person",
        "name": "Dj",
        "image": "//www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&s=250",
        "url": "http://localhost:2368/author/dj",
        "sameAs": ""
    },
    "headline": "Saving Private Functions",
    "url": "http://localhost:2368/saving-private-functions/",
    "datePublished": "2014-01-23T20:39:52.000Z",
    "dateModified": "2014-09-01T07:40:34.000Z",
    "keywords": "javascript, shell",
    "description": "Extending the Mongo Shell In the last blog post, we had a look at how you could make the Mongo Shell work more efficiently for you by using a combination of JavaScript functions and the Shell’s edit helper. But..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="Compose Articles" href="http://localhost:2368/rss/">
</head>

<body class="post-template tag-javascript tag-shell blend-mode">

  <header class="branding" role="banner">
    <a class="logo" href="../"><span class="hidden">Compose</span></a>
    <a class="menu-trigger" href="index.html#?"></a>
    <nav class="main-nav" data-yield="primary_nav" role="navigation">
      <a href="http://127.0.0.1:2368/mongodb/">MongoDB</a>
      <a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a>
      <a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a>
      <a href="http://127.0.0.1:2368/redis/">Redis</a>
      <a href="http://127.0.0.1:2368/postgresql/">PostgreSQL</a>
      <a href="https://app.compose.io">Sign in</a>
      <a class="signup" href="../signup/">Sign up</a>
    </nav>
  </header>
  <main class="content container" role="main">

    


<article class="post tag-javascript tag-shell container">
  <header>
    <h1 class="post-title">Saving Private Functions</h1>
    <small class="post-meta"><time class="post-date" datetime="2014-01-23">January 23rd, 2014</time></small>
  </header>

<h2 id="extendingthemongoshell">Extending the Mongo Shell</h2>

<p>In the <a href="http://blog.mongohq.com/how-i-stopped-worrying-and-learned-to-love-the-mongo-shell/">last blog post</a>, we had a look at how you could make the Mongo Shell work more efficiently for you by using a combination of JavaScript functions and the Shell’s <code>edit</code> helper. But we were left with the problem that for all the efficiency gains, none of the functions defined would be preserved into the next session with the shell. So now, we’ll look at some ways to create persistent functions and even share them with other database and shell users.</p>

<p>The first stop on our persistence quest is the <code>.monogorc.js</code> file. This is a file that is automatically loaded and run in the shell before the first prompt appears and can contain JavaScript code. We can use this file to set variables we need set, such as the name of the editor for the <code>edit</code> helper to use:</p>

<p><code>EDITOR=“vi”</code></p>

<p>Or we can put an often used function definition in there. In the previous post we created the <code>oneFrom</code> function to help randomly select values when creating test data so we would add that to <code>.mongorc.js</code> like so:</p>

<pre><code>function oneFrom(list) {  
  return list[Math.floor(Math.random()*list.length)];
}```

So now we have a way of persisting very commonly used functions in the shell, though when we do update the file remember we have to either restart the shell (recommended) or run `load(‘.mongorc.js’)` (assuming you are running Mongo Shell from your home directory and that you don’t mind the updated version being mingled with the current state of the shell).

How about other collections of functions you may want to load? You could always load them manually using Mongo Shell’s `load(‘filename’)` which we just used. But this means your workflow is going to be split between the shell and an editor, regularly reloading if you are debugging and if you use the Shell’s `edit` helper changes you make there will not be reflected in the file you loaded the function from.

You may think this is an easy problem to fix and that there’s a JavaScript save or file writing command somewhere that will take care of the issue. The thing is, there aren’t any file writing commands in JavaScript. They weren’t really in JavaScript as it was designed to be run in a browser safely – reading and writing local files from a browser is somewhat unsafe. JavaScript is much more comfortable with getting data from URLs. Other JavaScript based platforms that work outside the browser, like Node.js, have implemented their own file I/O libraries. In Mongo Shell’s case the `load` command we used is a MongoDB specific extension but there’s no save command to go with it.

Fear not though, we are working with a database too here and one thing that databases are good at is storing things. Lets look at how we can save a function in a collection. Let’s start by looking at what a JavaScript function is by first defining a simple one:

&gt; **`function example() { print("Example"); }`**

In JavaScript, functions are first class objects, like strings and numbers. The declaration of a function like this actually creates a variable called `example` and sets its value to a function object. You can ask the variable what type it is:

`&gt; ``typeof example``function`

If you ask for the value of `example` a function will return its entire definition; although it looks like a string on the console. It is a function though and if you add some parentheses to the end, you’ll ask the JavaScript engine to execute that function. So entering `example()` into the shell will print “Example”.

You can also find out what name the function was defined with it by calling `example.name`, which here would return “example”. Note though that not all functions can have a name – anonymous functions are assigned to a variable or used as parameters and don’t need a name. The name of a function sticks with the function too. If you assigned `resample=example`, then `resample()` would still print “Example” and `resample.name` would still return “example”. With this knowledge, it is fairly simple to write our function into a collection that we will call `functionstash`:

`&gt; ``db.functionstash.insert({ _id:example.name, fn:example });`

Functions, as a first class object, can be stored in MongoDB – they have their own BSON type which means they can be safely stored and restored. If you exit the shell and relaunch it, you can now get the function back by doing:

`&gt; ``example=db.functionstash.findOne({_id:"example"});`

And then you can call it up with `example()`. Note that you could restore it to any variable name, but the function would retain its function name. But all of that is a lot of typing and we could always make it simpler.

With that in mind, allow us to introduce a bit of JavaScript code which can live in your `.mongorc.js` file as “stash”. Here’s the code:
</code></pre>

<p>var stash={ <br>
  "save":
  function(func) {
    db.functionstash.update({ <em>id:func.name },
      { fn:func },
      { upsert:true } );
  },
  "load":
  function(name) {
    return db.functionstash.findOne({ _id:name }).fn;
  },
  "list":
  function() {
    db.functionstash.find().forEach(
      function(func) { print(func.</em>id); })
  }
}```</p>

<p>This little block of code adds the commands <code>stash.save(functionname)</code>, <code>stash.load("functionname")</code> and <code>stash.list()</code> to your Mongo Shell. To try these out, lets first empty the functionstash collection…</p>

<p><code>&gt; ``db.functionstash.remove()</code></p>

<p>Now, let’s create and save a function:</p>

<p>`&gt; ````
function example() { print("Example") }  </p>

<blockquote>
  <p>stash.save(example)```</p>
</blockquote>

<p>And the function is saved. To see what functions are already saved, we can use the list function:</p>

<p><code>&gt; ``stash.list()``example</code></p>

<p>And to get back the function, we need to just retrieve it and assign it to an appropriate variable:</p>

<p>`&gt; ``example=stash.load("example")````
function example() { print("Example") }  </p>

<blockquote>
  <p><code>
  `example()````
  Example <br>
  </code></p>
</blockquote>

<p>So now you can save and share functions with other users. At some point, you will probably want a file copy of all the functions you’ve been saving in the database and again, you’ll hit the problem that the Mongo Shell doesn’t have file writing capabilities. The easiest way to get that list is to run the shell and, on its command-line, ask it to evaluate query on the stash and redirect the output to a file, like this:</p>

<p><code>mongo --quiet -eval "db.functionstash.find().forEach(function(func) { print(func.fn) })" &gt;myfunctions.js</code></p>

<p>This is only the start of what you can do with the Mongo Shell. You could, for example, extend the stash functions to keep old versions and documentation or you could create a fluent interface for your day-to-day tasks. How far can you take it? Well, it is possible to extend the functionality of the shell quite dramatically, as the developer behind <a href="https://github.com/TylerBrock/mongo-hacker">mongo-hacker</a> has done, adding a huge amount of JavaScript to <code>.mongorc.js</code> to add an enhanced color-highlighting user interface, shell helpers, extra db.collection commands and much more.</p>

<p>Or you can simply add features you want to your own shell settings as you master the Mongo Shell and JavaScript. Like adding</p>

<p><code>DBQuery.prototype._prettyShell = true</code></p>

<p>to your <code>.mongorc.js</code> to always have your queries return pretty-printed versions instead of having to always add <code>.pretty()</code> to get that effect.</p>

<p>The power to save time and typing is now yours.</p>


<footer class="post-footer big-push">


    <figure class="author">
      <a href="../author/dj/">
        <img src="http://www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&amp;s=250" alt="Dj">
      </a>
      <figcaption>
        <p>Written on <time class="post-date" datetime="2015-03-13">March 13th, 2015</time> by</p>
        <a href="../author/dj/">Dj</a>
          <p>Content Curator at Compose, Dj has been both a developer and writer since Apples came in ][ flavors and Commodores had Pets.</p>
      </figcaption>
    </figure>




  <nav class="post-nav">
    <section class="site-nav">
      <a class="article-index" data-tooltip="Article Index" href="http://localhost:2368">
        <span class="hidden">Article Index</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#index"></use>
        </svg>
      </a>
      <a class="subscribe-button" data-tooltip="Suscribe" href="http://localhost:2368/rss/">
        <span class="hidden">Subscribe</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#subscribe"></use>
        </svg>
      </a>
    </section>
    <section class="share-nav">
      <a class="twitter-button" data-tooltip="Share on Twitter" href="https://twitter.com/share?text=Saving%20Private%20Functions&amp;url=http://localhost:2368/saving-private-functions/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#twitter"></use>
        </svg>
      </a>
      <a class="facebook-button" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/saving-private-functions/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#facebook"></use>
        </svg>
      </a>
      <a class="google-plus-button" data-tooltip="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:2368/saving-private-functions/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#google-plus"></use>
        </svg>
      </a>
    </section></nav>
  
</footer>

</article>



  </main>

  <footer class="colophon full-push" role="contentinfo">
    <nav>
      <dl>
        <dt>Company</dt>
        <dd><a href="http://127.0.0.1:2368/about-us/">About Us</a><a href="http://blog.compose.io/">Blog</a><a href="http://docs.compose.io/policies">Policies</a><a href="http://127.0.0.1:2368/pricing/">Plans <span class="amp">&amp;</span> Pricing </a><a href="http://127.0.0.1:2368/database-as-a-service/">Database as a Service</a>
        </dd>
      </dl>
      <dl>
        <dt>Support</dt>
        <dd><a href="http://status.compose.io/">System Status</a><a href="http://docs.compose.io/">Support</a><a href="http://docs.compose.io/">Docs</a><a href="http://127.0.0.1:2368/security/">Security</a><a href="https://docs.compose.io/support/new_request.html/?page=www">Contact Us</a>
        </dd>
      </dl>
      <dl>
        <dt>Databases</dt>
        <dd><a href="http://127.0.0.1:2368/mongodb/">MongoDB</a><a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a><a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a><a href="http://127.0.0.1:2368/redis/">Redis</a><a href="http://127.0.0.1:2368/enhanced/">Enhanced</a>
        </dd>
      </dl>
      <dl>
        <dt>Deployments</dt>
        <dd><a href="http://127.0.0.1:2368/aws/">AWS</a><a href="http://127.0.0.1:2368/digitalocean/">DigitalOcean</a><a href="http://127.0.0.1:2368/softlayer/">SoftLayer</a><a href="http://127.0.0.1:2368/gogrid/">GoGrid</a>
        </dd>
      </dl>
    </nav>
    <p>© 2015 Compose. All rights reserved. </p>
  </footer>
  <script src="../public/jquery.js?v=682061ecfb"></script>

  <script type="text/javascript" src="../assets/js/site.js?v=682061ecfb"></script>

</body>
