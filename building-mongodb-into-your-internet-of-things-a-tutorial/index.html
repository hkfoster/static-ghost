
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Building MongoDB into your Internet of Things: A Tutorial</title>
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="../favicon.ico">

  <script>
  // Uncomment for testing purposes
  // localStorage.clear();
  
  // Place in <head> above all stylesheet declarations
  function loadFont( fontName, woffUrl, woff2Url ) {
  
    // Test for support
    var browser   = navigator.userAgent,
        noSupport = !window.addEventListener || ( browser.match( /(Android (2|3|4.0|4.1|4.2|4.3))|(Opera (Mini|Mobi))/ ) && !browser.match( /Chrome/ ) );
  
    // Return if not supported
    if ( noSupport ) {
      return;
    }
  
    // Set up localStorage
    var loSto = {};
    try {
      loSto = localStorage || {};
    } catch ( ex ) {}
  
    var localStoragePrefix = 'x-font-' + fontName,
        localStorageUrlKey = localStoragePrefix + 'url',
        localStorageCssKey = localStoragePrefix + 'css',
        storedFontUrl      = loSto[ localStorageUrlKey ],
        storedFontCss      = loSto[ localStorageCssKey ];
  
    // Set up <style> element
    var styleElement = document.createElement( 'style' );
    styleElement.rel = 'stylesheet';
    document.head.appendChild( styleElement );
  
    // localStorage check
    if ( storedFontCss && ( storedFontUrl === woffUrl || storedFontUrl === woff2Url ) ) {
  
      // Apply font style sheet
      styleElement.textContent = storedFontCss;
  
    } else {
  
      // Apply new font (WOFF2 if supported)
      var url = ( woff2Url && supportsWoff2() ) ? woff2Url : woffUrl;
  
      // Fetch font data
      var request = new XMLHttpRequest();
      request.open( 'GET', url );
      request.onload = function() {
        if ( request.status >= 200 && request.status < 400 ) {
  
          // Update localStorage
          loSto[ localStorageUrlKey ] = url;
          loSto[ localStorageCssKey ] = styleElement.textContent = request.responseText;
        }
      };
      request.send();
    }
  
    // Check for WOFF2 support
    function supportsWoff2() {
      if ( !window.FontFace ) {
        return false;
      }
  
      var f = new FontFace( 't', 'url( "data:application/font-woff2," ) format( "woff2" )' );
      f.load();
  
      return f.status === 'loading';
    }
  }
  
  // Instantiate font loader
  loadFont(
    'Proxima Nova',
    '/assets/css/fonts-woff.css?v=682061ecfb',
    '/assets/css/fonts-woff2.css?v=682061ecfb'
  );
  </script>
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=682061ecfb">

  <link rel="canonical" href="http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/">
    
    <meta property="og:site_name" content="Compose Articles">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Building MongoDB into your Internet of Things: A Tutorial">
    <meta property="og:description" content="With the Internet of Things (IoT) poised to start pouring data into your organization, we thought it would be a good time to show you how you can bring that data into MongoDB so you can start analyzing it. In...">
    <meta property="og:url" content="http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/">
    <meta property="article:published_time" content="2014-02-11T18:10:24.000Z">
    <meta property="article:modified_time" content="2014-09-01T07:36:29.000Z">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Building MongoDB into your Internet of Things: A Tutorial">
    <meta name="twitter:description" content="With the Internet of Things (IoT) poised to start pouring data into your organization, we thought it would be a good time to show you how you can bring that data into MongoDB so you can start analyzing it. In...">
    <meta name="twitter:url" content="http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Compose Articles",
    "author": {
        "@type": "Person",
        "name": "Dj",
        "image": "//www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&s=250",
        "url": "http://localhost:2368/author/dj",
        "sameAs": ""
    },
    "headline": "Building MongoDB into your Internet of Things: A Tutorial",
    "url": "http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/",
    "datePublished": "2014-02-11T18:10:24.000Z",
    "dateModified": "2014-09-01T07:36:29.000Z",
    "description": "With the Internet of Things (IoT) poised to start pouring data into your organization, we thought it would be a good time to show you how you can bring that data into MongoDB so you can start analyzing it. In..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="Compose Articles" href="http://localhost:2368/rss/">
</head>

<body class="post-template blend-mode">

  <header class="branding" role="banner">
    <a class="logo" href="../"><span class="hidden">Compose</span></a>
    <a class="menu-trigger" href="index.html#?"></a>
    <nav class="main-nav" data-yield="primary_nav" role="navigation">
      <a href="http://127.0.0.1:2368/mongodb/">MongoDB</a>
      <a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a>
      <a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a>
      <a href="http://127.0.0.1:2368/redis/">Redis</a>
      <a href="http://127.0.0.1:2368/postgresql/">PostgreSQL</a>
      <a href="https://app.compose.io">Sign in</a>
      <a class="signup" href="../signup/">Sign up</a>
    </nav>
  </header>
  <main class="content container" role="main">

    


<article class="post container">
  <header>
    <h1 class="post-title">Building MongoDB into your Internet of Things: A Tutorial</h1>
    <small class="post-meta"><time class="post-date" datetime="2014-02-11">February 11th, 2014</time></small>
  </header>

<p><em><span style="line-height: 1.5em;">With the Internet of Things (IoT) poised to start pouring data into your organization, we thought it would be a good time to show you how you can bring that data into MongoDB so you can start analyzing it.</span></em></p>

<p>In this article, we’re going to build a simple data acquisition device, use a common IoT protocol to efficiently get its data to a server, and then we’ll show how to plug into that server and turn the acquired data into a time series document in a MongoDB collection. More specifically we’re using a standard protocol, <a href="http://mqtt.org/">MQTT</a>, for moving the data from an Arduino-based temperature sensor to a message broker and then use just over 32 lines of JavaScript to move that data into MongoDB. And we’ll show you how you can put this together yourself.</p>

<p>For this, we are going to start with a single thing in our Internet of Things – a temperature sensor running on an <a href="http://www.arduino.cc/">Arduino</a> micro-controller board. Don’t worry if you haven’t got one though, as we’ll show you how to simulate one in software later on. The Arduino is a great platform for experimenting with electronics, sensors and the various ways you can connect devices to the Internet and have the added bonus of being a lot of fun to work with.</p>

<h2 id="fromdevicetoserverwithmqtt">From device to server with MQTT</h2>

<p>First though, lets talk about that protocol – MQTT. This is a protocol that’s been created to allow devices to publish-and-subscribe to messages being broadcast over an TCP/IP network. These messages are simply composed of a topic and a payload; its up to the system designer to decide how the payload is formatted, but MQTT can handle everything from ethernet packet sized data to megabytes. Devices publish their messages through an MQTT client library up to a broker which then passes them on to any other client which has subscribed to them. Topics mean that a client may publish information with a topic “demo/devices/mydevicename” and another client which has subscribed to messages for “demo/devices/+” will get the first client’s messages, along with any other publishing client using a matching topic. All this is done with minimal overheads and small libraries available on many platforms at the client end.</p>

<p>Now you may wonder if the device is connected to the network, and likely to even have access to the Internet, so why not just connect to the database directly and insert data straight into documents? This is a potential strategy, but you would have to make sure that your database connectivity library was small enough and resource restrained enough to run on things like micro-controllers and that its connections didn’t assume the underlying network was reliable. MQTT has options for managing unreliable connections, from queuing messages locally to complex acknowledgement handshaking, and it has the added benefit of being a publish-<strong>and</strong>-subscribe system and therefore a two-way channel for information with useful features like “wills” where a client can register for a message to be sent if it goes away unexpectedly. You can also easily embed MQTT libraries in desktop, server and web applications to generate messages for administration or mining. <a href="http://mqtt.org/wiki/software">MQTT software</a> is also available for other platforms including <a href="http://eclipse.org/paho/">Java and C</a>; if you want to know more about MQTT using Java, see the article <a href="http://www.infoq.com/articles/practical-mqtt-with-paho">Practical MQTT with Paho</a>.</p>

<h2 id="buildinganetworkedtemperaturemonitor">Building a networked temperature monitor</h2>

<p>Which brings us to the Arduino we are using and the <a href="http://knolleary.net/arduino-client-for-mqtt/">MQTT library</a> available for it. The library implements a particular subset of MQTT, mainly due to limitations of the Arduino which is a microcontroller rather than a fully fledged computer system. But there is one thing the Arduino lacks and that’s an Ethernet port; luckily there are what are called “shields” – plug in boards – which can provide one the required port. In other scenarios, the Arduino could use a Wi-Fi or GSM shield for its networking connection, but we’ll stick with the low-cost, old-school wired ethernet for our work.</p>

<p>What the Arduino does have is a range of I/O ports and we’ll attach a temperature sensor to one of the analog ports. For those of you who want to know the details of the hardware and software setup on the Arduino, consult this <a href="http://blog.mongohq.com/a-temperature-sensing-and-networked-arduino/" title="A tem­per­a­ture sens­ing and net­worked Arduino">page</a> where we have the components and code listed. If you don’t have an Arduino but do have a Raspberry Pi or Beaglebone Black and would like to use these more capable computers then this <a href="http://www.eclipse.org/paho/talkingsmall/talking_small.html">article</a> from the Eclipse Foundation on MQTT and small computers should offer some guidance.</p>

<p>When you’ve assembled your Arduino, you’ll have a device sending MQTT messages with a temperature (in centigrade) as a value and a topic “demo/devices/arduino01”, reflecting it’s the first Arduino we’re setting up. The software is configured so that messages are sent when there is a sufficient change and at a maximum rate of one a second.</p>

<h2 id="brokeringdataconversations">Brokering data conversations</h2>

<p>The messages get sent to an MQTT broker and for this we’re using the open source <a href="http://mosquitto.org/">Mosquitto</a> broker but there are a range of different brokers available. Mosquitto has the advantage of being very simple to <a href="http://mosquitto.org/download/">download</a> and get running on Windows, Mac and Linux. On Mac OS X, you can use the <a href="http://brew.sh/">Homebrew</a> package manager to build and install Mosquitto with the command <code>brew install mosquitto</code>. Mosquitto also includes two tools, mosquitto<em>pub and mosquitto</em>sub which can publish messages and subscribe to messages from the command line. If you don’t have an Arduino configured, you can use mosquitto_pub to simulate a device sending out a temperature with</p>

<p><code>mosquitto_pub -h localhost -m “25” -t “demo/devices/arduino01”</code></p>

<p>Many different devices, and applications, can send their messages to the one broker and, similarly, they can all also subscribe to the broker to listen for messages that are of interest to them. Our device is sending out its temperature data to a topic and we’re going to assume that our plan will be to have many temperature monitors sending in their data to topics like demo/devices/arduino02, 03, 04 and so on. Now we’ll want to subscribe to those messages in order to send them onwards to MongoDB.</p>

<h2 id="frommosquittotomongodb">From Mosquitto to MongoDB</h2>

<p>For this part of the data voyage, we are going to use JavaScript and the popular <a href="http://nodejs.org/">Node.js</a>  platform. Node.js has a MQTT package and a MongoDB driver. On the Mac, if you don’t have Node but previously installed Homebrew, just run <code>brew install node</code>. For other platforms, or for Homebrew-less Mac users, go to the <a href="http://nodejs.org/">Node.js</a> site and click “Install” for an appropriate package. Once that’s installed run <code>npm install mqtt mongodb</code> to install the required packages.</p>

<p>The code itself is relatively simple. After including the libraries…</p>

<pre><code>var mqtt=require('mqtt')  
var mongodb=require('mongodb');```

and setting up some variables, like the URI for our MongoDB server…
</code></pre>

<p>var mqtt=require('mqtt') <br>
var mongodb=require('mongodb'); <br>
var mongodbClient=mongodb.MongoClient; <br>
var mongodbURI='mongodb://username:password@server.mongohq.com:port/database' <br>
var deviceRoot="demo/device/" <br>
var collection,client;```</p>

<p>You’ll need to change that URI to match your own MongoDB instance. The code starts up by connecting to the MongoDB server and sets up a callback to the <code>setupCollection</code> function. This means that when it runs, once it has has completed connection, it calls back to that function…</p>

<pre><code>mongodbClient.connect(mongodbURI,setupCollection);

function setupCollection(err,db) {  
 if(err) throw err;
 collection=db.collection("test_mqtt");
 client=mqtt.createClient(1883,'localhost')
 client.subscribe(deviceRoot+"+")
 client.on('message', insertEvent);
}```

Within `setupCollection`, the code creates a client to the Mosquitto server on the system and subscribes to “demo/device/+” with a callback to the `insertEvent` function – once run, every time a message is posted with a topic which matches that subscription, the function will be called with the topic and payload of the message.
</code></pre>

<p>function insertEvent(topic,payload) { <br>
 var key=topic.replace(deviceRoot,'');```</p>

<p>The <code>insertEvent</code> function takes the topic and payload and then strips off the “demo/device/“ from the topic. It uses the remaining path, which is our device name, as a key for the MongoDB collection. The payload in this case is just a single value, so we don’t need to do any parsing, but if it were a more complex payload, we would do that parsing her. After that is done, all we need to do is update the document by pushing the payload value and a timestamp into the events array. We use an “upsert” to create the document if it doesn’t already exist.</p>

<pre><code>collection.update(  
 { _id:key }, 
 { $push: { events: { event: { value:payload, when:new Date() } } } }, 
 { upsert:true },
 function(err,docs) {
    if(err) { console.log("Insert fail"); } // Improve error handling
 }
 )
}```

As an aside, we are adding the timestamp here rather than at the device because, apart from using a single clock, it means we don’t need to have real time clocks in devices, like our Arduino, to timestamp messages; clocks need batteries and cost money and, at scale, that can be a lot of money and required maintenance.

With this code running in Node and all being well, messages published to the broker will appear. If we look at some data in the server we find…
</code></pre>

<p>{
 _id: "arduino01", 
 events: [ 
 { event: { value: "31", when: ISODate("2014-02-05T15:31:07.431Z") } },
 { event: { value: "32", when: ISODate("2014-02-05T15:31:08.432Z") } }, 
 { event: { value: "33", when: ISODate("2014-02-05T15:31:09.432Z") } }, 
 { event: { value: "32", when: ISODate("2014-02-05T15:31:10.434Z") } }…
 ]
}```</p>

<p>And so we’ve moved temperature data from a microcontroller into MongoDB ready for whatever use we can come up with. These are the barest bones of a solution. For example, for more complex applications there are alternative brokers like <a href="https://github.com/mcollina/mosca">Mosca</a> which are embeddable in Node applications and work with more messaging protocols.</p>

<p>This article should though have given you the basic tools to make MongoDB a thing in your Internet of Things.</p>


<footer class="post-footer big-push">


    <figure class="author">
      <a href="../author/dj/">
        <img src="http://www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&amp;s=250" alt="Dj">
      </a>
      <figcaption>
        <p>Written on <time class="post-date" datetime="2015-03-13">March 13th, 2015</time> by</p>
        <a href="../author/dj/">Dj</a>
          <p>Content Curator at Compose, Dj has been both a developer and writer since Apples came in ][ flavors and Commodores had Pets.</p>
      </figcaption>
    </figure>




  <nav class="post-nav">
    <section class="site-nav">
      <a class="article-index" data-tooltip="Article Index" href="http://localhost:2368">
        <span class="hidden">Article Index</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#index"></use>
        </svg>
      </a>
      <a class="subscribe-button" data-tooltip="Suscribe" href="http://localhost:2368/rss/">
        <span class="hidden">Subscribe</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#subscribe"></use>
        </svg>
      </a>
    </section>
    <section class="share-nav">
      <a class="twitter-button" data-tooltip="Share on Twitter" href="https://twitter.com/share?text=Building%20MongoDB%20into%20your%20Internet%20of%20Things%3A%20A%20Tutorial&amp;url=http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#twitter"></use>
        </svg>
      </a>
      <a class="facebook-button" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#facebook"></use>
        </svg>
      </a>
      <a class="google-plus-button" data-tooltip="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:2368/building-mongodb-into-your-internet-of-things-a-tutorial/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#google-plus"></use>
        </svg>
      </a>
    </section></nav>
  
</footer>

</article>



  </main>

  <footer class="colophon full-push" role="contentinfo">
    <nav>
      <dl>
        <dt>Company</dt>
        <dd><a href="http://127.0.0.1:2368/about-us/">About Us</a><a href="http://blog.compose.io/">Blog</a><a href="http://docs.compose.io/policies">Policies</a><a href="http://127.0.0.1:2368/pricing/">Plans <span class="amp">&amp;</span> Pricing </a><a href="http://127.0.0.1:2368/database-as-a-service/">Database as a Service</a>
        </dd>
      </dl>
      <dl>
        <dt>Support</dt>
        <dd><a href="http://status.compose.io/">System Status</a><a href="http://docs.compose.io/">Support</a><a href="http://docs.compose.io/">Docs</a><a href="http://127.0.0.1:2368/security/">Security</a><a href="https://docs.compose.io/support/new_request.html/?page=www">Contact Us</a>
        </dd>
      </dl>
      <dl>
        <dt>Databases</dt>
        <dd><a href="http://127.0.0.1:2368/mongodb/">MongoDB</a><a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a><a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a><a href="http://127.0.0.1:2368/redis/">Redis</a><a href="http://127.0.0.1:2368/enhanced/">Enhanced</a>
        </dd>
      </dl>
      <dl>
        <dt>Deployments</dt>
        <dd><a href="http://127.0.0.1:2368/aws/">AWS</a><a href="http://127.0.0.1:2368/digitalocean/">DigitalOcean</a><a href="http://127.0.0.1:2368/softlayer/">SoftLayer</a><a href="http://127.0.0.1:2368/gogrid/">GoGrid</a>
        </dd>
      </dl>
    </nav>
    <p>© 2015 Compose. All rights reserved. </p>
  </footer>
  <script src="../public/jquery.js?v=682061ecfb"></script>

  <script type="text/javascript" src="../assets/js/site.js?v=682061ecfb"></script>

</body>
