
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Node.js, MongoDB and pool pollution problems</title>
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="../favicon.ico">

  <script>
  // Uncomment for testing purposes
  // localStorage.clear();
  
  // Place in <head> above all stylesheet declarations
  function loadFont( fontName, woffUrl, woff2Url ) {
  
    // Test for support
    var browser   = navigator.userAgent,
        noSupport = !window.addEventListener || ( browser.match( /(Android (2|3|4.0|4.1|4.2|4.3))|(Opera (Mini|Mobi))/ ) && !browser.match( /Chrome/ ) );
  
    // Return if not supported
    if ( noSupport ) {
      return;
    }
  
    // Set up localStorage
    var loSto = {};
    try {
      loSto = localStorage || {};
    } catch ( ex ) {}
  
    var localStoragePrefix = 'x-font-' + fontName,
        localStorageUrlKey = localStoragePrefix + 'url',
        localStorageCssKey = localStoragePrefix + 'css',
        storedFontUrl      = loSto[ localStorageUrlKey ],
        storedFontCss      = loSto[ localStorageCssKey ];
  
    // Set up <style> element
    var styleElement = document.createElement( 'style' );
    styleElement.rel = 'stylesheet';
    document.head.appendChild( styleElement );
  
    // localStorage check
    if ( storedFontCss && ( storedFontUrl === woffUrl || storedFontUrl === woff2Url ) ) {
  
      // Apply font style sheet
      styleElement.textContent = storedFontCss;
  
    } else {
  
      // Apply new font (WOFF2 if supported)
      var url = ( woff2Url && supportsWoff2() ) ? woff2Url : woffUrl;
  
      // Fetch font data
      var request = new XMLHttpRequest();
      request.open( 'GET', url );
      request.onload = function() {
        if ( request.status >= 200 && request.status < 400 ) {
  
          // Update localStorage
          loSto[ localStorageUrlKey ] = url;
          loSto[ localStorageCssKey ] = styleElement.textContent = request.responseText;
        }
      };
      request.send();
    }
  
    // Check for WOFF2 support
    function supportsWoff2() {
      if ( !window.FontFace ) {
        return false;
      }
  
      var f = new FontFace( 't', 'url( "data:application/font-woff2," ) format( "woff2" )' );
      f.load();
  
      return f.status === 'loading';
    }
  }
  
  // Instantiate font loader
  loadFont(
    'Proxima Nova',
    '/assets/css/fonts-woff.css?v=682061ecfb',
    '/assets/css/fonts-woff2.css?v=682061ecfb'
  );
  </script>
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=682061ecfb">

  <link rel="canonical" href="http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/">
    
    <meta property="og:site_name" content="Compose Articles">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Node.js, MongoDB and pool pollution problems">
    <meta property="og:description" content="With their shared affinities for JavaScript and JSON, Node.js and MongoDB are often referred to as perfect partners. Together, they make developing server-side applications fun and storing JSON data direct and easy. The only thing to watch out for...">
    <meta property="og:url" content="http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/">
    <meta property="article:published_time" content="2014-03-18T17:49:31.000Z">
    <meta property="article:modified_time" content="2014-09-01T07:23:39.000Z">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Node.js, MongoDB and pool pollution problems">
    <meta name="twitter:description" content="With their shared affinities for JavaScript and JSON, Node.js and MongoDB are often referred to as perfect partners. Together, they make developing server-side applications fun and storing JSON data direct and easy. The only thing to watch out for...">
    <meta name="twitter:url" content="http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Compose Articles",
    "author": {
        "@type": "Person",
        "name": "Dj",
        "image": "//www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&s=250",
        "url": "http://localhost:2368/author/dj",
        "sameAs": ""
    },
    "headline": "Node.js, MongoDB and pool pollution problems",
    "url": "http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/",
    "datePublished": "2014-03-18T17:49:31.000Z",
    "dateModified": "2014-09-01T07:23:39.000Z",
    "description": "With their shared affinities for JavaScript and JSON, Node.js and MongoDB are often referred to as perfect partners. Together, they make developing server-side applications fun and storing JSON data direct and easy. The only thing to watch out for..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="Compose Articles" href="http://localhost:2368/rss/">
</head>

<body class="post-template blend-mode">

  <header class="branding" role="banner">
    <a class="logo" href="../"><span class="hidden">Compose</span></a>
    <a class="menu-trigger" href="index.html#?"></a>
    <nav class="main-nav" data-yield="primary_nav" role="navigation">
      <a href="http://127.0.0.1:2368/mongodb/">MongoDB</a>
      <a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a>
      <a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a>
      <a href="http://127.0.0.1:2368/redis/">Redis</a>
      <a href="http://127.0.0.1:2368/postgresql/">PostgreSQL</a>
      <a href="https://app.compose.io">Sign in</a>
      <a class="signup" href="../signup/">Sign up</a>
    </nav>
  </header>
  <main class="content container" role="main">

    


<article class="post container">
  <header>
    <h1 class="post-title">Node.js, MongoDB and pool pollution problems</h1>
    <small class="post-meta"><time class="post-date" datetime="2014-03-18">March 18th, 2014</time></small>
  </header>

<p>With their shared affinities for JavaScript and JSON, Node.js and MongoDB are often referred to as perfect partners. Together, they make developing server-side applications fun and storing JSON data direct and easy. The only thing to watch out for is the intricacies of Node.js that make it easy to fall into bad patterns, such as creating too many connections to the database and thus overloading it. To avoid this bad pattern, we need to start with some Node.js basics.</p>

<h2 id="theproblem">The problem</h2>

<p>Powered by a single thread, Node.js runs its JavaScript code sequentially within one process, constantly passing through an event loop powered by <a href="https://github.com/joyent/libuv">libuv</a>. IO operations happen asynchronously with code for any IO posting a callback function to be invoked when the IO is done. If we take the simple example of using the Node.js native driver for Mongo…</p>

<pre><code>&lt;code class="language-javascript"&gt;var mongodb = require('mongodb')  
      , MongoClient = mongodb.MongoClient

MongoClient.connect(process.env.MONGOHQ_URL, function(err, db) {  
   db.collection('users').find({}).toArray(function(err, users) {
      console.log(users);
    })
 })
</code></pre>

<p>We put the processing within the callback function for the <code>MongoClient.connect()</code> call. Running this, the code prints the contents of the users collection and never exits because its stuck in the event loop, waiting for an event.</p>

<p>Now, say we have a simple web server; here’s one using the express framework which responds to requests for “/users” with a simple message:</p>

<pre><code>&lt;code class="language-javascript"&gt;var express = require('express')  
  , app = express()

app.get('/users', function(req, res) {  
         res.send("Would send users")
})

app.listen(1337)  
</code></pre>

<p>The “obvious” way of bringing the code together would be to replace the message with the database processing code like so…</p>

<pre><code>&lt;code class="language-javascript"&gt;var mongodb = require('mongodb')  
  , MongoClient = mongodb.MongoClient
  , express = require('express')
  , app = express()

app.get('/users', function(req, res) {  
   MongoClient.connect(process.env.MONGOHQ_URL, function(err, db) {
    db.collection('users').find({}).toArray(function(err, users) {
      res.json(users)
    })
  })
})

app.listen(1337)  
</code></pre>

<p>And if you run this program, it will work in the worst possible way. If we keep reloading the page and then log into the MongoDB server with the shell and run</p>

<p><aside class="right-gutter">As well as eating up connections, this code also starts the web server but waits till a request is made before even attempting to connect to the database – if there’s a problem, the first user to connect finds it</aside><code>db.serverStatus().connections</code> we will find that after only a realatively few reloads, we’ve eaten up half the available connections:</p>

<pre><code>&lt;code class="language-javascript"&gt;&gt; db.serverStatus().connections  
{ "current" : 526, "available" : 293, "totalCreated" : NumberLong(657) }
</code></pre>

<p>The problem is not only that we are creating a new connection to service every request, we are in fact creating five. The MongoDB driver for Node.js is built to be shared and can handle multiple requests. To allow for this it opens five connections to the server and places them in a pool ready to service database requests. And what we’ve done is negated that code by creating a connection every time.</p>

<h2 id="thesimplefix">The Simple Fix</h2>

<p>The easiest way to fix this problem is to open the database connection once and reuse it. Thats as simple as swapping two lines of code so that</p>

<pre><code>&lt;code class="language-javascript"&gt;app.get('/users', function(req, res) {  
   MongoClient.connect(process.env.MONGOHQ_URL, function(err, db) {
   ….
becomes

MongoClient.connect(process.env.MONGOHQ_URL, function(err, db) {  
   app.get('/users', function(req, res) {
      db.collection('users').find({}).toArray(function(err, users) {
       res.json(users)
    })
  })
})
</code></pre>

<p>The drawback here, at least for the developer, is that all the request routing code now sits inside a function and that’s not as maintainable as it could be.</p>

<h2 id="analternativefix">An Alternative Fix</h2>

<p>One thing about Node.js is that it maintains state while running its event loop. Set a global namespace variable and it stays set. We can leverage that to create a db variable which we initialize at startup.</p>

<pre><code>&lt;code class="language-javascript"&gt;var mongodb = require('mongodb')  
  , MongoClient = mongodb.MongoClient
  , express = require('express')
  , app = express()

var db;

MongoClient.connect(process.env.MONGOHQ_URL, function(err, database) {  
        db=database;
        app.listen(1337)
})

app.get('/users', function(req, res) {  
   db.collection('users').find({}).toArray(function(err, users) {
   res.json(users)
  })
})
</code></pre>

<p>Taking it further, we could create a global variable for the collection, initialize that after connecting to the database and using the variable in place of references to the <code>db.collection('users')</code>, reducing the chance of errors creeping in where the collection name is incorrectly entered.</p>


<footer class="post-footer big-push">


    <figure class="author">
      <a href="../author/dj/">
        <img src="http://www.gravatar.com/avatar/3c427b45eb4d51770a5ec7f9e4d62c9f?d=404&amp;s=250" alt="Dj">
      </a>
      <figcaption>
        <p>Written on <time class="post-date" datetime="2015-03-13">March 13th, 2015</time> by</p>
        <a href="../author/dj/">Dj</a>
          <p>Content Curator at Compose, Dj has been both a developer and writer since Apples came in ][ flavors and Commodores had Pets.</p>
      </figcaption>
    </figure>




  <nav class="post-nav">
    <section class="site-nav">
      <a class="article-index" data-tooltip="Article Index" href="http://localhost:2368">
        <span class="hidden">Article Index</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#index"></use>
        </svg>
      </a>
      <a class="subscribe-button" data-tooltip="Suscribe" href="http://localhost:2368/rss/">
        <span class="hidden">Subscribe</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#subscribe"></use>
        </svg>
      </a>
    </section>
    <section class="share-nav">
      <a class="twitter-button" data-tooltip="Share on Twitter" href="https://twitter.com/share?text=Node.js%2C%20MongoDB%20and%20pool%20pollution%20problems&amp;url=http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#twitter"></use>
        </svg>
      </a>
      <a class="facebook-button" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#facebook"></use>
        </svg>
      </a>
      <a class="google-plus-button" data-tooltip="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:2368/node-js-mongodb-and-pool-pollution-problems/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
        <svg>
          <use xlink:href="/assets/images/icons.svg#google-plus"></use>
        </svg>
      </a>
    </section></nav>
  
</footer>

</article>



  </main>

  <footer class="colophon full-push" role="contentinfo">
    <nav>
      <dl>
        <dt>Company</dt>
        <dd><a href="http://127.0.0.1:2368/about-us/">About Us</a><a href="http://blog.compose.io/">Blog</a><a href="http://docs.compose.io/policies">Policies</a><a href="http://127.0.0.1:2368/pricing/">Plans <span class="amp">&amp;</span> Pricing </a><a href="http://127.0.0.1:2368/database-as-a-service/">Database as a Service</a>
        </dd>
      </dl>
      <dl>
        <dt>Support</dt>
        <dd><a href="http://status.compose.io/">System Status</a><a href="http://docs.compose.io/">Support</a><a href="http://docs.compose.io/">Docs</a><a href="http://127.0.0.1:2368/security/">Security</a><a href="https://docs.compose.io/support/new_request.html/?page=www">Contact Us</a>
        </dd>
      </dl>
      <dl>
        <dt>Databases</dt>
        <dd><a href="http://127.0.0.1:2368/mongodb/">MongoDB</a><a href="http://127.0.0.1:2368/elasticsearch/">Elasticsearch</a><a href="http://127.0.0.1:2368/rethinkdb/">RethinkDB</a><a href="http://127.0.0.1:2368/redis/">Redis</a><a href="http://127.0.0.1:2368/enhanced/">Enhanced</a>
        </dd>
      </dl>
      <dl>
        <dt>Deployments</dt>
        <dd><a href="http://127.0.0.1:2368/aws/">AWS</a><a href="http://127.0.0.1:2368/digitalocean/">DigitalOcean</a><a href="http://127.0.0.1:2368/softlayer/">SoftLayer</a><a href="http://127.0.0.1:2368/gogrid/">GoGrid</a>
        </dd>
      </dl>
    </nav>
    <p>© 2015 Compose. All rights reserved. </p>
  </footer>
  <script src="../public/jquery.js?v=682061ecfb"></script>

  <script type="text/javascript" src="../assets/js/site.js?v=682061ecfb"></script>

</body>
